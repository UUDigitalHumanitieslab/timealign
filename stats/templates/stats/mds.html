{% extends "base/base.html" %} {% load bootstrap3 %} {% load static %} {% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.4/nv.d3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.4/nv.d3.css">
<link href="{%static 'style.css' %}" rel="stylesheet" type="text/css" /> {% endblock %} {% block content %}

<h2>MDS visualization (scenario
    <em>
        <a href="{% url 'stats:show' scenario.pk %}" target="_blank">{{ scenario.title }}</a>
    </em>)</h2>
<p>
    <em>Stress: {{ stress|floatformat:"-3" }}</em>
</p>

<div class="alert alert-info alert-dismissable" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    This scatter plot shows the results Multidimensional Scaling of the dissimilarity matrix of tense tuples. Please see the
    <a href="{% url 'project' %}" class="alert-link">project summary</a> for more details.
</div>

<div id="chart">
    <svg style="height: 490px; width: 100%"></svg>
</div>

<h2>Filters</h2>

<div class="alert alert-info alert-dismissable" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    Below, you can change the labels and the dimensions displayed on the x- and y-axis. Click the green button to confirm your
    selection and update the scatter plot.
</div>

<div class="row">
    Language:
    <div id="language" class="btn-group" data-toggle="buttons">
        {% for l in languages %}
        <label class="btn btn-primary active">
            <input type="radio" name="options" value="{{ l.iso }}" autocomplete="off">{{ l.title }}
        </label>
        {% endfor %}
    </div>
    Dimension on x-axis:
    <div id="d1" class="btn-group" data-toggle="buttons">
        {% for d in max_dimensions %}
        <label class="btn btn-primary active">
            <input type="radio" name="options" value="{{ d }}" autocomplete="off">{{ d }}
        </label>
        {% endfor %}
    </div>
    Dimension on y-axis:
    <div id="d2" class="btn-group" data-toggle="buttons">
        <label class="btn btn-primary active">
            <input type="radio" name="options" value="0" autocomplete="off">&empty;
        </label>
        {% for d in max_dimensions %}
        <label class="btn btn-primary active">
            <input type="radio" name="options" value="{{ d }}" autocomplete="off">{{ d }}
        </label>
        {% endfor %}
    </div>
    <button type="submit" class="btn btn-success">
        {% bootstrap_icon "ok" %} Go!
    </button </div>

    <!-- <button id="bruh-btn" class="btn btn-primary">
        Toggle Brush
    </button </div> -->

    <!-- Form for posting data to server -->
    <form name="fragmentform" action="." method="post">
        {% csrf_token %}
        <!-- <input type="text" name="csrfmiddlewaretoken"> -->
        <input type="hidden" name="fragment_ids">
        <input type="hidden" name="tenses">
    </form>

    <div class="loading-overlay" style="display:none">
        <div id="spinner" class="spinner">
            <img id="img-spinner" src="{%static 'images/spinner.gif'%}" alt="Loading" />
        </div>
    </div>

    <script>
        var matrix = {{ matrix| safe }};

        nv.addGraph(function () {
            // Start a scatter plot, force the X and Y axis to good defaults,
            // and use specific colors for tenses rather than the defaults
            var chart = nv.models.scatterChart()
                .forceX([-.5, .5])
                .forceY([-.5, .5])
                .color(function (d) { return d.color; });

            // Set a proper tick format for the axes
            chart.xAxis.tickFormat(d3.format('.02f'));
            chart.yAxis.tickFormat(d3.format('.02f'));

            // Show the tenses in the tooltip
            chart.tooltip.contentGenerator(function (e) {
                return '<strong>' + e.point.fragment_id + '</strong>: <em>' + e.point.fragment + '</em><br>' + e.point.tenses;
            });

            // Create a click-through to the data
            chart.scatter.dispatch.on("elementClick", function (e) {
                // console.log(e.point);
                // $('.loading-overlay').show();
                select_neighbours(e.point);
                // window.location = "{% url 'annotations:show' 999 %}".replace(999, e.point.fragment_id);

            });

            // Add the data to the chart and start creating the chart
            d3.select('#chart svg')
                .datum(matrix)
                .transition()
                .duration(350)
                .call(chart);



            // ****************************************
            // Brush functionality 
            // ****************************************

            // var brushC = d3.select('#chart svg g');
            // brushC.empty() ? brushC.append('g') : brushC.select('g')
            //     .attr("class", "brush")
            //     .call(d3.svg.brush()
            //         .x(chart.xAxis.scale())
            //         .y(chart.yAxis.scale())
            //         .on('brushend', naiveUpdateBrush)
            //         .extent([0, 0])

            //     )
            //     .selectAll('rect')
            //     .attr('height', 320)//change according to you chart height
            //     //i have hard coded it since it was a 'quick and dirty' fix
            //     //you may try to get it from chart, if you can please update me.
            //     ;

            function select_neighbours(origin, distance = .1) {
                var brushedNodes = [];
                // for (tense of matrix) {
                //     for (point of tense.values) {
                //         if (within_distance(origin, point, distance)) {
                //             if (_.isEqual(point.tenses.sort(), origin.tenses.sort())) {
                //                 brushedNodes.push(point.fragment_id)
                //                 // console.log(point)
                //             }
                //         }
                //     }
                // }

                var data = d3.selectAll('circle')
                console.log(data)
                for (circle of data[0]) {
                    var f = circle.__data__[4]
                    if (f != undefined) {
                        if (within_distance(origin, f, distance)) {
                            if (_.isEqual(f.tenses.sort(), origin.tenses.sort())) {
                                brushedNodes.push(f.fragment_id)
                                circle.className.baseVal = 'selected'
                                circle.className.animVal = 'selected'
                                // console.log(d3.selectAll('.selected'))
                                d3.selectAll('.selected').style('fill', 'yellow').attr('r', 5)
                                // console.log(circle.cx.baseVal.value)
                                // d3.select('#chart svg')
                                //     .append('circle')
                                //     .attr('cx', circle.cx.baseVal.value)
                                //     .attr('cy', circle.cy.baseVal.value)
                                //     .attr('r', circle.r.baseVal.value)
                                //     .style('stroke', 'black')
                                //     .style('fill', 'yellow')
                            }
                        }
                    }
                }

                d3.select('#chart svg')
                    .append('circle')
                    .attr('cx', chart.xAxis.range(0))
                    .attr('cy', chart.yAxis.range(0))
                    .attr('r', 5)
                    .attr('class', ' test')
                    .style('stroke', 'black')
                    .style('fill', 'yellow')
                // console.log(chart.xAxis)
                console.log(chart.xAxis.scale())
                console.log(d3.select('.test'))
                console.log(brushedNodes);

                // var data = d3.selectAll('circle')
                // console.log(data[0])
                // console.log(data[0][0].__data__[4])
                // nvd3 Highlighting Nodes
                // var data = d3.select('#chart svg').datum()
                // var next = d3.select('.nv-groups')
                //     .selectAll("circle.myPoint")
                //     .data(data.filter(function (d) { return $.inArray(d.fragment_id, brushedNodes) }))
                //     .enter().append("circle").attr("class", "myPoint")
                //     .attr("cx", function (d) { return (d.x) })
                //     .attr("cy", function (d) { return (d.y) })
                //     .attr("r", 5)
                // console.log(next);
                // console.log("Selected " + brushedNodes.length, " nodes.");
                // console.log(brushedNodes);
                $('input[name="tenses"]').val(JSON.stringify(origin.tenses));
                $('input[name="fragment_ids"]').val(JSON.stringify(brushedNodes));
                // $('form[name="fragmentform"]').submit();
            }

            function UpdateBrush() {
                const selection = d3.event.target.extent();
                const csrftoken = Cookies.get('csrftoken');
                var brushedNodes = [];
                for (tense of matrix) {
                    for (point of tense.values) {
                        if (rectContains(selection, [point.x, point.y]) &&
                            point.tenses == e.tenses) {
                            brushedNodes.push(point.fragment_id)
                        }
                    }
                }

                if (brushedNodes.length > 0) {
                    $('input[name="fragment_ids"]').val(JSON.stringify(brushedNodes));
                    $('form[name="fragmentform"]').submit();
                }
                else {
                    sel = d3.selectAll('.brush');
                    sel[0].call(d3.event.target.move, null);
                }
            }

            nv.utils.windowResize(chart.update);
            return chart;
        });
    </script>

    <script>
        $(function () {
            $("#language input[value='{{ language }}'").closest(".btn").button("toggle");
            $("#d1 input[value='{{ d1 }}'").closest(".btn").button("toggle");
            $("#d2 input[value='{{ d2 }}'").closest(".btn").button("toggle");

            $("button[type='submit']").click(function () {
                var l = $("#language > .btn.active > input").val();
                var d1 = $("#d1 > .btn.active > input").val();
                var d2 = $("#d2 > .btn.active > input").val();
                var url = "{% url 'stats:mds' scenario.pk 'language' 1111 2222 %}";
                window.location = url.replace("language", l).replace('1111', d1).replace('2222', d2);
            });
        });

        function rectContains(rect, point) {
            return rect[0][0] <= point[0] && point[0] <= rect[1][0] &&
                rect[0][1] <= point[1] && point[1] <= rect[1][1];
        };

        function distance(p1, p2) {
            var dx = p2.x - p1.x;
            var dy = p2.y - p1.y;
            return Math.sqrt(dx * dx + dy * dy);
        };

        function within_distance(origin, point, distance) {
            var dx = point.x - origin.x;
            var dy = point.y - origin.y;
            var d = Math.sqrt(dx * dx + dy * dy)

            return d <= distance
        }
    </script> {% endblock %}