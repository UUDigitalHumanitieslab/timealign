{% extends "base/base.html" %}
{% load bootstrap3 %}
{% load static %}
{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
<script src="{% static 'stats/mds.js' %}"></script>
<link href="{%static 'stats/style.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}

<h2>MDS visualization (scenario
    <em>
        <a href="{% url 'stats:show' scenario.pk %}" target="_blank">{{ scenario.title }}</a>
    </em>)</h2>
<p>
    <em>Stress: {{ stress|floatformat:"-3" }}</em>
</p>

<div class="alert alert-info alert-dismissable" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    This scatter plot shows the results Multidimensional Scaling of the dissimilarity matrix of tense tuples. Please see the
    <a href="{% url 'project' %}" class="alert-link">project summary</a> for more details.
</div>


<div id="chartLegend"></div>
<div id="chart"></div>
<h4>Scaling</h4>
Cluster size: <input type="range" min="1" max="100" value="50" class="slider" id="scale_a">
General size: <input type="range" min="1" max="6" value="1" class="slider" id="scale_b">

<h2>Filters</h2>

<div class="alert alert-info alert-dismissable" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    Below, you can change the labels and the dimensions displayed on the x- and y-axis. Click the green button to confirm your
    selection and update the scatter plot.
</div>

<div class="row">
    <div class="col-md-12">
        <p>
            Language:
            <div id="language" class="btn-group" data-toggle="buttons">
                {% for l in languages %}
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="{{ l.iso }}">{{ l.title }}
                </label>
                {% endfor %}
            </div>
            Dimension on x-axis:
            <div id="d1" class="btn-group" data-toggle="buttons">
                {% for d in max_dimensions %}
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="{{ d }}">{{ d }}
                </label>
                {% endfor %}
            </div>
            Dimension on y-axis:
            <div id="d2" class="btn-group" data-toggle="buttons">
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="0">&empty;
                </label>
                {% for d in max_dimensions %}
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="{{ d }}">{{ d }}
                </label>
                {% endfor %}
            </div>
        </p>
        <p>
            Clustering:
            <div id="clustering" class="btn-group" data-toggle="buttons">
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="yes">Yes
                </label>
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="no">No
                </label>
            </div>
            Labels:
            <div id="cluster_labels" class="btn-group" data-toggle="buttons">
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="yes">Yes
                </label>
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="no">No
                </label>
            </div>
            Convex hulls:
            <div id="hulls" class="btn-group" data-toggle="buttons">
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="yes">Yes
                </label>
                <label class="btn btn-primary">
                    <input type="radio" name="options" value="no">No
                </label>
            </div>
            <button type="submit" class="btn btn-success">
                {% bootstrap_icon "ok" %} Go!
            </button>
        </p>
    </div>
</div>

    <!-- Form for posting data to server -->
    <form name="fragmentform" action="." method="post">
        {% csrf_token %}
        <input type="hidden" name="fragment_ids">
        <input type="hidden" name="tenses">
    </form>

    <div class="loading-overlay" style="display:none">
        <div id="spinner" class="spinner">
            <img id="img-spinner" src="{% static 'stats/images/spinner.gif' %}" alt="Loading" />
        </div>
    </div>


    <script>
        var flat_data = {{ flat_data | safe}};
        var series_list = {{ series_list | safe}};
        var clusters = {{ clusters | safe}};
        var options = {
            clustered: '{{ clustering }}' == 'yes',
            clusterLabels: '{{ cluster_labels }}' == 'yes',
            hulls: '{{ hulls }}' == 'yes',
        };
        var mds = MDSView(flat_data, series_list, clusters, options);

        function rescale() {
            var a = $('#scale_a').val() / 100;
            var b = $('#scale_b').val();
            mds.rescale(a, b);
        }
        $('#scale_a').change(rescale);
        $('#scale_b').change(rescale);

        if (window.location.hash) {
            mds.configure_from_hash(window.location.hash.substring(1));
        }
    </script>

    <script>
        $(function () {
            $("#language input[value='{{ language }}'").closest(".btn").addClass("active");
            $("#d1 input[value='{{ d1 }}'").closest(".btn").addClass("active");
            $("#d2 input[value='{{ d2 }}'").closest(".btn").addClass("active");
            $("#clustering input[value='{{ clustering }}'").closest(".btn").addClass("active");
            $("#cluster_labels input[value='{{ cluster_labels }}'").closest(".btn").addClass("active");
            $("#hulls input[value='{{ hulls }}'").closest(".btn").addClass("active");

            $("button[type='submit']").click(function () {
                var l = $("#language > .btn.active > input").val();
                var d1 = $("#d1 > .btn.active > input").val();
                var d2 = $("#d2 > .btn.active > input").val();
                var url = "{% url 'stats:mds' scenario.pk 'language' 1111 2222 %}";
                var clustering = $("#clustering > .btn.active > input").val();
                var clusterLabels = $("#cluster_labels > .btn.active > input").val();
                var hulls = $("#hulls > .btn.active > input").val();
                window.location = url.replace("language", l).replace('1111', d1).replace('2222', d2) +
                                  '?clustering=' + clustering +
                                  '&labels=' + clusterLabels +
                                  '&hulls=' + hulls +
                                  window.location.hash;
            });
        });

        function rectContains(rect, point) {
            return rect[0][0] <= point[0] && point[0] <= rect[1][0] &&
                rect[0][1] <= point[1] && point[1] <= rect[1][1];
        };

        function distance(p1, p2) {
            var dx = p2.x - p1.x;
            var dy = p2.y - p1.y;
            return Math.sqrt(dx * dx + dy * dy);
        };

        function within_distance(origin, point, distance) {
            var dx = point.x - origin.x;
            var dy = point.y - origin.y;
            var d = Math.sqrt(dx * dx + dy * dy)

            return d <= distance
        }
    </script>
{% endblock %}
